[13-postgresql-acid-normalization.excalidraw](13-postgresql-acid-normalization.excalidraw.md)
# PosgreSQL. ACID, Нормальні форми бази даних

# Зміст

- [ACID](#acid)
- [Нормалізація баз даних](#%D0%9D%D0%BE%D1%80%D0%BC%D0%B0%D0%BB%D1%96%D0%B7%D0%B0%D1%86%D1%96%D1%8F-%D0%B1%D0%B0%D0%B7-%D0%B4%D0%B0%D0%BD%D0%B8%D1%85)
- [Література](#%D0%9B%D1%96%D1%82%D0%B5%D1%80%D0%B0%D1%82%D1%83%D1%80%D0%B0)


## ACID

**ACID** (англ. _**Atomicity, Consistency, Isolation, Durability**_) — це набір властивостей, що гарантують надійну роботу транзакцій бази даних: атомарність, узгодженість, ізольованість, довговічність.  
В контексті баз даних, послідовність операцій з базою даних, яка задовольняє властивостям ACID, можна розглядати як одну логічну операцію над даними. Така послідовність операцій називається транзакцією. Наприклад, переказ коштів з одного банківського рахунку на інший містить численні операції, але є єдиною транзакцією.

1983 року Андреа Рейтер і Тео Хардер ввели акронім ACID, ґрунтуючись на вимогах, які сформулював раніше науковець Джим Грей.  
![](attachments/Pasted%20image%2020240403103656.png)
[https://uk.wikipedia.org/wiki/ACID](https://uk.wikipedia.org/wiki/ACID)  

**Вимоги**  

За Рейтером та Хардером, вимоги до цих чотирьох властивостей наступні:

**Atomicity — Атомарність**  
Транзакції часто містять в собі багато операцій. Атомарність гарантує, що жодна транзакція не буде виконана частково. Будуть або виконані всі операції, що беруть участь у транзакції, або не виконано жодної. Якщо протягом роботи однієї з операцій виникне помилка і операцію буде відхилено, то будуть відхилені також усі інші зміни, здійснені в межах транзакції. Система має бути атомарною у кожній ситуації, враховуючи відключення електроенергії, помилки та збої. Гарантія атомарності перешкоджає частковому оновленню бази даних, яке насправді може спричинити ще більші проблеми, аніж оновлення всієї бази в межах однієї транзакції.

Прикладом атомарної транзакції є переказ грошей з рахунку на рахунок, який проходить двома операціями: зняття грошей з першого рахунку та збереження їх на другому. Виконання цих операцій в атомарній транзакції забезпечує узгодженість даних бази, тобто гроші не віднімуться та не зарахуються, якщо одна з цих двох операцій зазнає невдачі.

**Consistency — Узгодженість**  
Відповідно до вимоги узгодженості, система має перебувати в узгодженому, несуперечливому стані до початку дії транзакції і по її завершенню. При цьому вона може перебувати в неузгодженому стані протягом виконання транзакції, проте ця неузгодженість не буде видимою за межами транзакції завдяки іншим властивостям — атомарності та ізольованості.

Таким чином, узгодженість гарантує інваріантивність бази даних: будь-які дані, записані в базу, мають відповідати усім визначеним правилам, враховуючи обмеження, каскади, тригери та будь-яку їхню комбінацію. Це запобігає пошкодженню бази даних некоректною транзакцією, але не гарантує правильність транзакції. Посилальну цілісність гарантує відношення унікального ключа до зовнішнього.

Наприклад, при переведенні коштів з рахунку на рахунок, кошти можна спочатку зняти з першого рахунку, після чого нараховувати на другий. Відповідно, після зняття коштів, але до їх нарахування система перебуває в неузгодженому стані: коштів немає на жодному з рахунків. Але після завершення транзакції повна сума перебуватиме на другому (або першому у випадку скасування транзакції) рахунку.

**Isolation — Ізольованість**  
Ізольованість означає, що жодні проміжні зміни не будуть видимі за межами транзакції аж до її завершення. Питання ізоляції стає актуальним при одночасній роботі багатьох транзакцій з тими самими даними. За цією вимогою, якщо дві транзакції намагатимуться змінити одні й ті самі дані, то одну з них буде відхилено або призупинено до завершення другої.

**Durability — Довговічність**  
Довговічність гарантує, що незалежно від інших проблем після відновлення працездатності системи результати завершених транзакцій будуть збережені. Іншими словами, якщо користувач отримав повідомлення про успішне завершення транзакції, то він може бути впевнений, що дані будуть збережені та відновлені у випадку збоїв.

## Нормалізація баз даних

![](attachments/Pasted%20image%2020240403103707.png)

**Нормалізація** - це процес упорядкування даних у базі даних таким чином, щоб вона була вільна від надлишковості та залежності. Це допомагає усунути невідповідності та аномалії даних, тим самим покращуючи цілісність даних. Нормалізація - це набір правил або вказівки щодо розробки схеми бази даних таким чином, щоб уникнути дублювання даних, надмірності даних і неузгодженості даних.


![](attachments/Pasted%20image%2020240403103732.png)

[Нормальні форми](https://uk.wikipedia.org/wiki/%D0%9D%D0%BE%D1%80%D0%BC%D0%B0%D0%BB%D1%96%D0%B7%D0%B0%D1%86%D1%96%D1%8F_%D0%B1%D0%B0%D0%B7_%D0%B4%D0%B0%D0%BD%D0%B8%D1%85)

Існує кілька нормальних форм, кожна з яких будується на попередній, які скеровують нас у процесі нормалізації. Найпоширенішими звичайними формами є:

*   _Перша нормальна форма (1NF)_: кожен стовпець має містити атомарні (неподільні) значення. У таблиці не повинно бути повторюваних груп або масивів даних.

*   _Друга нормальна форма (2NF):_ кожен неключовий стовпець має функціонально залежати від усього первинного ключа. Іншими словами, кожен стовпець у таблиці має бути пов’язаний із первинним ключем, а не залежати від будь-яких інших неключових стовпців.

*   _Третя нормальна форма (3NF)_: усі неключові стовпці мають залежати лише від первинного ключа, а не від будь-яких інших неключових стовпців. Це усуває транзитивні залежності.

Нормалізація зменшує надлишковість даних і залежність, роблячи базу даних більш ефективною, гнучкою та масштабованою. Це також допомагає підтримувати узгодженість і точність даних, а також гарантує належну обробку оновлень і видалень.

### Приклад нормалізації

Таблиця `Sales`, яка записує дані про продажі продуктів, включаючи зайву інформацію про продукт та клієнта:

```sql
CREATE TABLE Sales (
    SaleID INT PRIMARY KEY,
    ProductID INT,
    ProductName VARCHAR(50),
    ProductCategory VARCHAR(50),
    CustomerID INT,
    CustomerName VARCHAR(50),
    SaleDate DATE,
    Quantity INT,
    Price DECIMAL(10, 2)
);

INSERT INTO Sales VALUES
(1, 101, 'Laptop', 'Electronics', 501, 'John Doe', '2023-01-10', 1, 1200.00),
(2, 102, 'Smartphone', 'Electronics', 502, 'Jane Smith', '2023-01-11', 2, 800.00),
(3, 103, 'Backpack', 'Accessories', 503, 'Alice Johnson', '2023-01-12', 1, 70.00);
```

### Нормалізація до 3NF

#### 1. Створення таблиць для продуктів та клієнтів (1NF & 2NF)

Спочатку видаляємо повторювану інформацію про продукти та клієнтів, створюючи окремі таблиці для них.

```sql
CREATE TABLE Products (
    ProductID INT PRIMARY KEY,
    ProductName VARCHAR(50),
    Category VARCHAR(50),
    Price DECIMAL(10, 2)
);

INSERT INTO Products VALUES
(101, 'Laptop', 'Electronics', 1200.00),
(102, 'Smartphone', 'Electronics', 800.00),
(103, 'Backpack', 'Accessories', 70.00);

CREATE TABLE Customers (
    CustomerID INT PRIMARY KEY,
    CustomerName VARCHAR(50)
);

INSERT INTO Customers VALUES
(501, 'John Doe'),
(502, 'Jane Smith'),
(503, 'Alice Johnson');
```

#### 2. Оновлення таблиці `Sales` (3NF)

Далі, спрощуємо таблицю `Sales`, залишаючи лише зовнішні ключі, які посилаються на `Products` та `Customers`, усуваючи зайві дані.

```sql
ALTER TABLE Sales
DROP COLUMN ProductName,
DROP COLUMN ProductCategory,
DROP COLUMN CustomerName,
DROP COLUMN Price;

-- Оновлена таблиця `Sales` тепер виглядає так:
SELECT * FROM Sales;
```

Ця переглянута таблиця `Sales` разом з таблицями `Products` та `Customers` краще відповідає принципам 3НФ:

- **Перша нормальна форма (1NF):** Кожна таблиця має первинний ключ і не зберігає повторюваних груп або масивів.
- **Друга нормальна форма (2NF):** Усі неключові атрибути кожної таблиці повністю залежні від первинного ключа.
- **Третя нормальна форма (3NF):** Неключові атрибути не залежать від інших неключових атрибутів.



## Література
1.  [Нормальні форми бази даних](https://javarush.com/ua/quests/lectures/ua.questhibernate.level17.lecture02)
2.  [https://edu-python-course.github.io/\_build/html/uk/rdbms/normalization.html](https://edu-python-course.github.io/_build/html/uk/rdbms/normalization.html)
3.  [Нормалізація відношень при проектуванні БД](https://rdb.dp.ua/uk/chapter_03)
